<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/sonara/src/main/java/ua/markiyan/sonara/config/SecurityConfig.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/sonara/src/main/java/ua/markiyan/sonara/config/SecurityConfig.java" />
              <option name="originalContent" value="package ua.markiyan.sonara.config;&#10;&#10;import org.springframework.context.annotation.Bean;&#10;import org.springframework.context.annotation.Configuration;&#10;import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;&#10;import org.springframework.security.crypto.password.PasswordEncoder;&#10;&#10;@Configuration&#10;public class SecurityConfig {&#10;&#10;    @Bean&#10;    public PasswordEncoder passwordEncoder() {&#10;        return new BCryptPasswordEncoder();&#10;    }&#10;}&#10;&#10;" />
              <option name="updatedContent" value="package ua.markiyan.sonara.config;&#10;&#10;import lombok.RequiredArgsConstructor;&#10;import org.springframework.context.annotation.Bean;&#10;import org.springframework.context.annotation.Configuration;&#10;import org.springframework.http.HttpMethod;&#10;import org.springframework.security.authentication.AuthenticationManager;&#10;import org.springframework.security.authentication.ProviderManager;&#10;import org.springframework.security.authentication.dao.DaoAuthenticationProvider;&#10;import org.springframework.security.config.annotation.web.builders.HttpSecurity;&#10;import org.springframework.security.config.http.SessionCreationPolicy;&#10;import org.springframework.security.core.userdetails.UserDetailsService;&#10;import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;&#10;import org.springframework.security.crypto.password.PasswordEncoder;&#10;import org.springframework.security.web.SecurityFilterChain;&#10;import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;&#10;import ua.markiyan.sonara.security.JwtFilter;&#10;&#10;@Configuration&#10;@RequiredArgsConstructor&#10;public class SecurityConfig {&#10;&#10;    private final UserDetailsService userDetailsService;&#10;    private final JwtFilter jwtFilter;&#10;&#10;    @Bean&#10;    public PasswordEncoder passwordEncoder() {&#10;        return new BCryptPasswordEncoder();&#10;    }&#10;&#10;    @Bean&#10;    public AuthenticationManager authenticationManager() {&#10;        DaoAuthenticationProvider provider = new DaoAuthenticationProvider();&#10;        provider.setUserDetailsService(userDetailsService);&#10;        provider.setPasswordEncoder(passwordEncoder());&#10;        return new ProviderManager(provider);&#10;    }&#10;&#10;    @Bean&#10;    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {&#10;        http&#10;                .csrf().disable()&#10;                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)&#10;                .and()&#10;                .authorizeHttpRequests(auth -&gt; auth&#10;                        .requestMatchers(HttpMethod.POST, &quot;/api/users&quot;).permitAll()&#10;                        .requestMatchers(&quot;/api/auth/**&quot;, &quot;/swagger-ui.html&quot;, &quot;/v3/api-docs/**&quot;, &quot;/swagger-ui/**&quot;).permitAll()&#10;                        .anyRequest().authenticated()&#10;                )&#10;                .addFilterBefore(jwtFilter, UsernamePasswordAuthenticationFilter.class);&#10;        return http.build();&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/sonara/src/main/java/ua/markiyan/sonara/controller/AuthController.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/sonara/src/main/java/ua/markiyan/sonara/controller/AuthController.java" />
              <option name="originalContent" value="&#10;" />
              <option name="updatedContent" value="package ua.markiyan.sonara.controller;&#10;&#10;import lombok.RequiredArgsConstructor;&#10;import org.springframework.http.ResponseEntity;&#10;import org.springframework.security.authentication.AuthenticationManager;&#10;import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;&#10;import org.springframework.security.core.AuthenticationException;&#10;import org.springframework.web.bind.annotation.*;&#10;import ua.markiyan.sonara.security.JwtUtil;&#10;import ua.markiyan.sonara.service.UserService;&#10;&#10;import java.util.Map;&#10;&#10;@RestController&#10;@RequestMapping(&quot;/api/auth&quot;)&#10;@RequiredArgsConstructor&#10;public class AuthController {&#10;&#10;    private final AuthenticationManager authManager;&#10;    private final JwtUtil jwtUtil;&#10;    private final UserService userService;&#10;&#10;    @PostMapping(&quot;/login&quot;)&#10;    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; login(@RequestBody Map&lt;String, String&gt; req) {&#10;        try {&#10;            String email = req.get(&quot;email&quot;);&#10;            String password = req.get(&quot;password&quot;);&#10;            authManager.authenticate(new UsernamePasswordAuthenticationToken(email, password));&#10;            var user = userService.findByEmail(email);&#10;            String token = jwtUtil.generateToken(user.email(), Map.of(&quot;userId&quot;, user.id()));&#10;            return ResponseEntity.ok(Map.of(&quot;token&quot;, token));&#10;        } catch (AuthenticationException ex) {&#10;            return ResponseEntity.status(401).build();&#10;        }&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/sonara/src/main/java/ua/markiyan/sonara/dto/request/AuthRequest.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/sonara/src/main/java/ua/markiyan/sonara/dto/request/AuthRequest.java" />
              <option name="updatedContent" value="package ua.markiyan.sonara.dto.request;&#10;&#10;public record AuthRequest(String email, String password) {}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/sonara/src/main/java/ua/markiyan/sonara/dto/response/AuthResponse.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/sonara/src/main/java/ua/markiyan/sonara/dto/response/AuthResponse.java" />
              <option name="updatedContent" value="package ua.markiyan.sonara.dto.response;&#10;&#10;public record AuthResponse(String token) {}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/sonara/src/main/java/ua/markiyan/sonara/repository/UserRepository.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/sonara/src/main/java/ua/markiyan/sonara/repository/UserRepository.java" />
              <option name="originalContent" value="package ua.markiyan.sonara.repository;&#10;&#10;import java.util.Optional;&#10;import org.springframework.data.jpa.repository.JpaRepository;&#10;import ua.markiyan.sonara.entity.User;&#10;&#10;public interface UserRepository extends JpaRepository&lt;User, Long&gt; {&#10;    Optional&lt;User&gt; findByNameIgnoreCase(String name);&#10;    boolean existsByNameIgnoreCase(String name);&#10;}&#10;&#10;    Page&lt;User&gt; findByNameContainingIgnoreCaseOrEmailContainingIgnoreCase(String name, String email, Pageable pageable);&#10;}&#10;&#10;" />
              <option name="updatedContent" value="package ua.markiyan.sonara.repository;&#10;&#10;import java.util.Optional;&#10;import org.springframework.data.domain.Page;&#10;import org.springframework.data.domain.Pageable;&#10;import org.springframework.data.jpa.repository.JpaRepository;&#10;import ua.markiyan.sonara.entity.User;&#10;&#10;public interface UserRepository extends JpaRepository&lt;User, Long&gt; {&#10;    Optional&lt;User&gt; findByNameIgnoreCase(String name);&#10;    boolean existsByNameIgnoreCase(String name);&#10;&#10;    Page&lt;User&gt; findByNameContainingIgnoreCaseOrEmailContainingIgnoreCase(String name, String email, Pageable pageable);&#10;&#10;    Optional&lt;User&gt; findByEmailIgnoreCase(String email);&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/sonara/src/main/java/ua/markiyan/sonara/security/JwtFilter.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/sonara/src/main/java/ua/markiyan/sonara/security/JwtFilter.java" />
              <option name="updatedContent" value="package ua.markiyan.sonara.security;&#10;&#10;import jakarta.servlet.FilterChain;&#10;import jakarta.servlet.ServletException;&#10;import jakarta.servlet.http.HttpServletRequest;&#10;import jakarta.servlet.http.HttpServletResponse;&#10;import lombok.RequiredArgsConstructor;&#10;import org.springframework.lang.NonNull;&#10;import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;&#10;import org.springframework.security.core.context.SecurityContextHolder;&#10;import org.springframework.security.core.userdetails.UserDetails;&#10;import org.springframework.security.core.userdetails.UserDetailsService;&#10;import org.springframework.stereotype.Component;&#10;import org.springframework.web.filter.OncePerRequestFilter;&#10;&#10;import java.io.IOException;&#10;&#10;@Component&#10;@RequiredArgsConstructor&#10;public class JwtFilter extends OncePerRequestFilter {&#10;&#10;    private final JwtUtil jwtUtil;&#10;    private final UserDetailsService userDetailsService;&#10;&#10;    @Override&#10;    protected void doFilterInternal(@NonNull HttpServletRequest request, @NonNull HttpServletResponse response, @NonNull FilterChain filterChain) throws ServletException, IOException {&#10;        String authHeader = request.getHeader(&quot;Authorization&quot;);&#10;        if (authHeader != null &amp;&amp; authHeader.startsWith(&quot;Bearer &quot;)) {&#10;            String token = authHeader.substring(7);&#10;            try {&#10;                String username = jwtUtil.usernameFromToken(token);&#10;                if (username != null &amp;&amp; SecurityContextHolder.getContext().getAuthentication() == null) {&#10;                    UserDetails ud = userDetailsService.loadUserByUsername(username);&#10;                    UsernamePasswordAuthenticationToken auth = new UsernamePasswordAuthenticationToken(ud, null, ud.getAuthorities());&#10;                    SecurityContextHolder.getContext().setAuthentication(auth);&#10;                }&#10;            } catch (Exception ex) {&#10;                // invalid token -&gt; clear context and continue (endpoint may reject due to missing auth)&#10;                SecurityContextHolder.clearContext();&#10;            }&#10;        }&#10;        filterChain.doFilter(request, response);&#10;    }&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/sonara/src/main/java/ua/markiyan/sonara/security/JwtUtil.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/sonara/src/main/java/ua/markiyan/sonara/security/JwtUtil.java" />
              <option name="updatedContent" value="package ua.markiyan.sonara.security;&#10;&#10;import io.jsonwebtoken.*;&#10;import io.jsonwebtoken.security.Keys;&#10;import org.springframework.beans.factory.annotation.Value;&#10;import org.springframework.stereotype.Component;&#10;&#10;import java.security.Key;&#10;import java.util.Date;&#10;import java.util.Map;&#10;&#10;@Component&#10;public class JwtUtil {&#10;&#10;    private final Key key;&#10;    private final long expMs;&#10;&#10;    public JwtUtil(@Value(&quot;${app.jwt.secret}&quot;) String secret, @Value(&quot;${app.jwt.exp-ms}&quot;) long expMs) {&#10;        if (secret == null || secret.isBlank()) {&#10;            throw new IllegalStateException(&quot;JWT secret not configured (app.jwt.secret)&quot;);&#10;        }&#10;        this.key = Keys.hmacShaKeyFor(secret.getBytes());&#10;        this.expMs = expMs;&#10;    }&#10;&#10;    public String generateToken(String username, Map&lt;String, Object&gt; claims) {&#10;        long now = System.currentTimeMillis();&#10;        return Jwts.builder()&#10;                .setSubject(username)&#10;                .addClaims(claims)&#10;                .setIssuedAt(new Date(now))&#10;                .setExpiration(new Date(now + expMs))&#10;                .signWith(key, SignatureAlgorithm.HS256)&#10;                .compact();&#10;    }&#10;&#10;    public Jws&lt;Claims&gt; parseToken(String token) throws JwtException {&#10;        return Jwts.parserBuilder().setSigningKey(key).build().parseClaimsJws(token);&#10;    }&#10;&#10;    public String usernameFromToken(String token) {&#10;        return parseToken(token).getBody().getSubject();&#10;    }&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/sonara/src/main/java/ua/markiyan/sonara/service/UserService.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/sonara/src/main/java/ua/markiyan/sonara/service/UserService.java" />
              <option name="originalContent" value="package ua.markiyan.sonara.service;&#10;&#10;import ua.markiyan.sonara.dto.request.UserRequest;&#10;import ua.markiyan.sonara.dto.request.UserUpdateRequest;&#10;import ua.markiyan.sonara.dto.response.UserResponse;&#10;&#10;public interface UserService {&#10;    UserResponse create(UserRequest request);&#10;    UserResponse get(Long id);&#10;&#10;    UserResponse update(Long id, UserUpdateRequest req);&#10;    void delete(Long id);&#10;}&#10;&#10;    Page&lt;UserResponse&gt; search(String q, Pageable pageable);&#10;}&#10;" />
              <option name="updatedContent" value="package ua.markiyan.sonara.service;&#13;&#10;&#13;&#10;import org.springframework.data.domain.Page;&#13;&#10;import org.springframework.data.domain.Pageable;&#13;&#10;import ua.markiyan.sonara.dto.request.UserRequest;&#13;&#10;import ua.markiyan.sonara.dto.request.UserUpdateRequest;&#13;&#10;import ua.markiyan.sonara.dto.response.UserResponse;&#13;&#10;&#13;&#10;public interface UserService {&#13;&#10;    UserResponse create(UserRequest request);&#13;&#10;    UserResponse get(Long id);&#13;&#10;&#13;&#10;    UserResponse update(Long id, UserUpdateRequest req);&#13;&#10;    void delete(Long id);&#13;&#10;&#13;&#10;    Page&lt;UserResponse&gt; search(String q, Pageable pageable);&#13;&#10;&#13;&#10;    UserResponse findByEmail(String email);&#13;&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>